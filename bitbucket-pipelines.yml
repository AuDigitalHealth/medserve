# This is a sample build configuration for Java (Maven).
# Check our guides at https://confluence.atlassian.com/x/zd-5Mw for more examples.
# Only use spaces to indent your .yml configuration.
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
image: maven:3.3.9

pipelines:    
  branches:
    master:
      - step:
          caches:
            - maven
            - terminology
          script:
            - docker login -p $DOCKER_PASSWORD -u $DOCKER_USERNAME
            - mvn -B deploy -P '!docker' -Dsynd.cache.dir=$BITBUCKET_CLONE_DIR/terminology
            - cd server/fhir-server
            - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
            - docker build --tag dionmcm/medserve .
            - docker push dionmcm/medserve
            - cd ../medserve-proxy
            - docker build --tag dionmcm/medserve-proxy .
            - docker push dionmcm/medserve-proxy
            - ssh root@medserve.online 'docker-compose pull medserve proxy; docker-compose create medserve proxy; docker-compose up -d'
          services:
            - docker

definitions:
  caches:
    terminology: $BITBUCKET_CLONE_DIR/terminology
